<!DOCTYPE html>
<html translate="no">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Academia Ubuntu Rugby - A formar jovens, dentro e fora de campo desde 2013." />
    <title>Ubuntu Rugby • Loja</title>

    <link rel="shortcut icon" type="image/x-icon" href="resources/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="resources/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="resources/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="resources/favicon/favicon-16x16.png">
    <link rel="manifest" href="resources/favicon/site.webmanifest">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous" />

    <link rel="stylesheet" href="resources/css/style.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
</head>

<body class="shop-bg bg-dark text-white">
    <nav class="navbar navbar-expand-sm sticky-top">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="resources/images/logo1.png" alt="Ubuntu Rugby Logo" width="80" height="80" />
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="bi bi-list fs-1 text-white"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="w-100 d-flex justify-content-center">
                    <ul class="navbar-nav fs-5 gap-3">
                        <li class="nav-item">
                            <a class="nav-link" href="rugby_week.html">Campo Desportivo</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="about.html" id="navbarDarkDropdownMenuLink"
                                role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Projeto
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
                                <li><a class="dropdown-item" href="about.html">Sobre nós</a></li>
                                <li><a class="dropdown-item" href="values.html">Valores</a></li>
                                <li><a class="dropdown-item" href="teams.html">Equipas</a></li>
                            </ul>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="training.html">Treinos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="news.html">Notícias</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="shop.html">Loja</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="partners.html">Sócios</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="contacts.html">Contactos</a>
                        </li>
                    </ul>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-outline-light position-relative" id="cartButton" data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas" aria-controls="cartOffcanvas">
                        <i class="bi bi-cart3"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartCount">0</span>
                    </button>
                <div class="registration">
                    <a class="btn btn-dark btn-brand" href='https://docs.google.com/forms/d/e/1FAIpQLScWad4BTzEXU8SoE3Hf_WUfhAttyhwxmo9vKIiA6DedclHyog/viewform' target="_blank"
                        rel="noopener noreferrer">
                        INSCRIÇÃO
                    </a>
                </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- Modal for viewing larger image -->
    <div id="imageModal" class="modal margin-mobile">
        <span class="close">&times;</span>
        <img class="modal-content" id="modalImg">
        <div id="caption"></div>
    </div>
    <div class="my-5 container animate__animated animate__fadeInLeft">
        <div class="container-fluid">
            <!-- Shop Header -->
            <div class="container text-center my-5">
                <h2 class="display-5 font-impact">LOJA</h2>
            </div>

            <!-- Shop Items Grid -->
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="shop-items">
                <!-- Dynamic Cards will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Cart Offcanvas -->
    <div class="offcanvas offcanvas-end bg-dark text-white" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title font-impact" id="cartOffcanvasLabel">Carrinho</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="alert alert-warning small" role="alert">
                Este formulário será utilizado para efetuar encomendas da Academia Ubuntu Rugby.<br/>
                Todas as encomendas efetuadas só serão válidas após efetuado o pagamento.<br/>
                O pagamento pode ser efetuado em dinheiro ou por Mbway, para o nº de telemóvel da AUR:<br/><strong>932 606 500</strong>.
            </div>
            <div id="cartItems"></div>
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-3">
                <strong>Total</strong>
                <strong id="cartTotal">0</strong>
                <img src="resources/images/rugby-ball.png" class="ms-1" alt="Rugby Ball" width="15" />
            </div>
            <div class="mb-3">
                <label for="buyerName" class="form-label">Nome</label>
                <input type="text" class="form-control" id="buyerName" placeholder="O seu nome">
            </div>
            <div class="mb-3">
                <label for="buyerPhone" class="form-label">Telefone</label>
                <input type="tel" class="form-control" id="buyerPhone" placeholder="(+351) 912 345 678">
            </div>
            <div class="mb-3">
                <label for="relation" class="form-label">Relação com a AUR</label>
                <select class="form-select" id="relation">
                    <option value="" selected>Selecione...</option>
                    <option value="Atleta/Sócio">Atleta/Sócio</option>
                    <option value="Outro">Outro</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="scale" class="form-label">Escalão</label>
                <select class="form-select" id="scale">
                    <option value="" selected>Selecione...</option>
                    <option>Sub-6</option>
                    <option>Sub-8</option>
                    <option>Sub-10</option>
                    <option>Sub-12</option>
                    <option>Sub-14</option>
                    <option>Sub-16</option>
                    <option>Sub-19</option>
                    <option>Sénior</option>
                    <option>Outro</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="payment" class="form-label">Método de pagamento</label>
                <select class="form-select" id="payment">
                    <option value="" selected>Selecione...</option>
                    <option>MBWay</option>
                    <option>Numerário</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="notes" class="form-label">Notas</label>
                <textarea class="form-control" id="notes" rows="3" placeholder="Tamanhos especiais, observações..."></textarea>
            </div>
            <button class="btn btn-success w-100" id="checkoutButton">Finalizar Pedido</button>
        </div>
    </div>

    <div class="footer bg-scnd px-5 pt-5 mt-5">
        <div class="container">
            <div class="row pb-5">
                <div class="col-md-4 logo-footer">
                    <img class="bg-white border p-2 rounded-circle" src="resources/images/logo.png"
                        alt="Ubuntu Rugby Logo" width="160" height="160" />
                </div>
                <div class="col-md-4 item-footer">
                    <h5 class="text-uppercase font-impact">Menu</h5>
                    <ul class="list-unstyled pt-4">
                        <li class="mb-2">
                            <a href="index.html" class="link-light">Início</a>
                        </li>
                        <li class="mb-2">
                            <a class="link-light" href='https://docs.google.com/forms/d/e/1FAIpQLScWad4BTzEXU8SoE3Hf_WUfhAttyhwxmo9vKIiA6DedclHyog/viewform' target="_blank"
                                rel="noopener noreferrer">
                                Inscrições
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="partners.html" class="link-light">Sócios</a>
                        </li>
                        <li>
                            <a href="contacts.html" class="link-light">Contactos</a>
                        </li>
                    </ul>
                </div>
                <div class="col-md-4 item-footer">
                    <h5 class="text-uppercase font-impact">Contactos</h5>
                    <ul class="list-unstyled pt-4">
                        <li class="mb-3">
                            <a class="contact" href="mailto:geral@ubunturugby.pt">
                                <i class="bi bi-envelope me-3"></i>
                                geral@ubunturugby.pt
                            </a>
                        </li>
                        <li>
                            <a class="contact" href="tel:+351932606500">
                                <i class="bi bi-telephone me-3"></i>
                                (+351) 932 606 500
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="text-center pb-5">
                Ubuntu Rugby <script>document.write(new Date().getFullYear());</script>
                <i class="bi bi-c-circle text-light"></i>
                All rights reserved.
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // Function to setup the image modal functionality
        function setupImageModal() {
            const modal = document.getElementById("imageModal");
            const modalImg = document.getElementById("modalImg");
            const captionText = document.getElementById("caption");

            // Get all product images
            const productImages = document.querySelectorAll(".product-image");

            productImages.forEach(image => {
                image.addEventListener("click", function () {
                    modal.style.display = "block";
                    modalImg.src = this.src;
                    captionText.innerHTML = this.alt;
                });
            });

            // Get the <span> element that closes the modal
            const closeBtn = document.getElementsByClassName("close")[0];
            closeBtn.onclick = function () {
                modal.style.display = "none";
            };
        }

        // Function to dynamically create the shop cards
        function createShopItems() {
            const container = document.getElementById('shop-items');
            shopItems.forEach(item => {
                const soldOut = item.sizes.every(size => !size.available);
                // !size.available
                const sizes = item.sizes.map(size => `
                    <button class="btn btn-sm me-1 mb-1 ${false ? 'btn-secondary' : 'btn-outline-light'} size-option" ${false ? 'disabled' : ''} data-size="${size.label}" data-item="${item.id}">
                        ${size.label}
                    </button>
                `).join('');
                const cardHTML = `
                    <div class="col d-flex justify-content-center ${soldOut ? 'sold-out' : ''}">
                        <a id="${item.id}">
                            <div class="card text-center border-secondary hover-maximize">
                                ${item.type && `<div class="badge badge-${item.type.toLowerCase()}">${item.type}</div>`}
                                <img src="resources/images/shop/${item.img}" class="card-img-top product-image" alt="${item.title}" />
                                ${soldOut ? '<div class="sold-out-overlay"></div>' : ''}
                                <div class="card-body">
                                    <h6 class="card-title">${item.title}</h6>
                                    <div class="d-flex flex-wrap justify-content-center my-2 size-wrapper">${sizes}</div>
                                    <hr />
                                    <div class="row">
                                        ${item.prices.others !== '' ? `
                                            <div class="col price-col">
                                                <small>Outros</small>
                                                <h5>${item.prices.others}<img src="resources/images/rugby-ball.png" class="ms-1 mb-1" alt="Rugby Ball" width="15px" /></h5>
                                            </div>
                                        ` : ''}
                                        <div class="col price-col">
                                            <small>Sócios/Atletas</small>
                                            <h5>${item.prices.members}<img src="resources/images/rugby-ball.png" class="ms-1 mb-1" alt="Rugby Ball" width="15px" /></h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer mb-2">
                                    ${soldOut ? `<button class="btn btn-danger w-100" disabled>Esgotado</button>` :
                                    `<div class="d-flex gap-2">
                                        <button class="btn ${item.orderOnly ? 'btn-warning' : 'btn-comprar'} w-100" data-add-to-cart="${item.id}">${item.orderOnly ? 'Apenas por Encomenda' : 'Adicionar ao Carrinho'}</button>
                                    </div>`}
                                </div>
                            </div>
                        </a>
                    </div>`;
                container.innerHTML += cardHTML;
            });

            setupImageModal();
            wireShopInteractions();
        }


        const csvFilePath = 'resources/Stock Merch 2024-25.csv';
        // Formspree endpoint: https://formspree.io/f/YOUR_FORM_ID
        // Create free account at formspree.io, create form for geral@ubunturugby.pt, copy endpoint here
        const ORDER_ENDPOINT = 'https://formspree.io/f/xkgdeaae';

        let shopItems = [];

        // Fetch the CSV file
        fetch(csvFilePath)
            .then(response => response.text())
            .then(csvData => {
                Papa.parse(csvData, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function (results) {
                        let idCounter = 1;

                        // Iterate over the parsed data
                        results.data.forEach(row => {
                            // Create the object for each row
                            const entry = {
                                id: `item-${idCounter++}`,
                                img: row['Item'].toLowerCase().replace(/ /g, '-') + '.png',
                                title: row['Item'],
                                sizes: [
                                    { label: 'Tamanho único', available: row['Tamanho único'] !== '' },
                                    { label: '6a', available: row['6a'] !== '' },
                                    { label: '8a', available: row['8a'] !== '' },
                                    { label: '9-11a', available: row['9-11a'] !== '' },
                                    { label: '10a', available: row['10a'] !== '' },
                                    { label: '12a', available: row['12a'] !== '' },
                                    { label: '12-13a', available: row['12-13a'] !== '' },
                                    { label: '14a', available: row['14a'] !== '' },
                                    { label: 'XS', available: row['XS'] !== '' },
                                    { label: 'S', available: row['S'] !== '' },
                                    { label: 'M', available: row['M'] !== '' },
                                    { label: 'L', available: row['L'] !== '' },
                                    { label: 'XL', available: row['XL'] !== '' },
                                    { label: 'XXL', available: row['XXL'] !== '' },
                                    { label: 'XXXL', available: row['XXXL'] !== '' },
                                    { label: 'Size 3', available: row['Size 3'] !== '' },
                                    { label: 'Size 4', available: row['Size 4'] !== '' },
                                    { label: 'Size 5', available: row['Size 5'] !== '' },
                                ],
                                prices: {
                                    others: row['Preço Outros'],
                                    members: row['Preço Membros']
                                },
                                link: row['Link'],
                                orderOnly: row['Apenas por encomenda'] !== '',
                                type: row['Tipo']
                            };
                            entry.sizes = entry.sizes.filter(size => row[size.label] !== 'x');
                            // Push the object into the array
                            shopItems.push(entry);
                        });
                    },
                    error: function (error) {
                        console.error("Error while parsing:", error.message);
                    }
                });
            }).then(() => {
                shopItems.sort((a, b) => {
                    const typeOrder = { 'Novidade': 2, 'Popular': 3 };
                    const aTypeOrder = typeOrder[a.type] || (a.type == '' ? 4 : 1);
                    const bTypeOrder = typeOrder[b.type] || (b.type == '' ? 4 : 1);

                    if (aTypeOrder !== bTypeOrder) return aTypeOrder - bTypeOrder;
                    return b.prices.members - a.prices.members;
                });
                // Call the function to render the shop items
                createShopItems();
            });

        // --- Simple Cart Logic ---
        const cart = JSON.parse(localStorage.getItem('ubuntuCart') || '[]');
        let priceMode = 'members'; // 'members' | 'others'

        function saveCart() {
            localStorage.setItem('ubuntuCart', JSON.stringify(cart));
            updateCartBadge();
        }

        function updateCartBadge() {
            const count = cart.reduce((sum, i) => sum + i.qty, 0);
            const badge = document.getElementById('cartCount');
            if (badge) badge.textContent = count;
        }

        function wireShopInteractions() {
            // Size selection toggle per item
            document.querySelectorAll('.size-option').forEach(btn => {
                btn.addEventListener('click', () => {
                    const itemId = btn.getAttribute('data-item');
                    const wrapper = btn.closest('.size-wrapper');
                    wrapper.querySelectorAll('.size-option').forEach(b => {
                        b.classList.remove('active', 'btn-light', 'text-dark');
                        if (!b.classList.contains('btn-secondary')) b.classList.add('btn-outline-light');
                    });
                    btn.classList.add('active', 'btn-light', 'text-dark');
                    btn.classList.remove('btn-outline-light');
                });
            });

            // Add to cart buttons (qty fixed to 1 here; ajustar depois no carrinho)
            document.querySelectorAll('[data-add-to-cart]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const itemId = btn.getAttribute('data-add-to-cart');
                    const item = shopItems.find(i => i.id === itemId);
                    if (!item) return;
                    const sizeActive = btn.closest('.card').querySelector('.size-option.active');
                    const size = sizeActive ? sizeActive.getAttribute('data-size') : null;
                    if (!size) {
                        alert('Por favor selecione um tamanho.');
                        return;
                    }
                    const qty = 1;
                    const existing = cart.find(ci => ci.id === item.id && ci.size === size);
                    if (existing) {
                        existing.qty += qty;
                    } else {
                        cart.push({ id: item.id, title: item.title, size, qty });
                    }
                    saveCart();
                    renderCart();
                    const offcanvasEl = document.getElementById('cartOffcanvas');
                    const oc = bootstrap.Offcanvas.getOrCreateInstance(offcanvasEl);
                    oc.show();
                });
            });

            updateCartBadge();
        }

        function priceStringForItem(item) {
            const isOthers = priceMode === 'others';
            const chosen = isOthers ? (item.prices.others || item.prices.members) : (item.prices.members || item.prices.others);
            return chosen || '0';
        }

        function priceNumber(str) {
            const n = parseFloat(String(str).replace(',', '.').replace(/[^0-9.]/g, ''));
            return isNaN(n) ? 0 : n;
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const totalEl = document.getElementById('cartTotal');
            if (!container) return;
            container.innerHTML = '';
            let total = 0;
            cart.forEach((ci, idx) => {
                const item = shopItems.find(i => i.id === ci.id);
                const priceStr = item ? priceStringForItem(item) : '0';
                const lineTotal = priceNumber(priceStr) * ci.qty;
                total += lineTotal;
                const row = document.createElement('div');
                row.className = 'd-flex justify-content-between align-items-center mb-2';
                row.innerHTML = `
                    <div>
                        <strong>${ci.title}</strong>
                        <div class="text-muted">Tamanho: ${ci.size}</div>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <input type="number" min="1" value="${ci.qty}" class="form-control form-control-sm" style="max-width:70px" data-cart-index="${idx}" />
                        <span>${priceStr}</span>
                        <img src="resources/images/rugby-ball.png" class="ms-1" alt="Rugby Ball" width="15" />
                        <button class="btn btn-sm btn-outline-danger" data-remove-index="${idx}"><i class="bi bi-trash"></i></button>
                    </div>`;
                container.appendChild(row);
            });
            totalEl.textContent = total.toString();

            // Wire qty changes
            container.querySelectorAll('[data-cart-index]').forEach(inp => {
                inp.addEventListener('change', () => {
                    const idx = parseInt(inp.getAttribute('data-cart-index'), 10);
                    const val = Math.max(1, parseInt(inp.value, 10));
                    cart[idx].qty = val;
                    saveCart();
                    renderCart();
                });
            });
            // Remove
            container.querySelectorAll('[data-remove-index]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = parseInt(btn.getAttribute('data-remove-index'), 10);
                    cart.splice(idx, 1);
                    saveCart();
                    renderCart();
                });
            });
        }

        async function submitOrderToSheet(order) {
            if (!ORDER_ENDPOINT) return { ok: false, skipped: true };
            try {
                // Format date as dd-mm-yyyy
                const date = new Date(order.timestamp);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                const formattedDate = `${day}-${month}-${year}`;
                
                // Format items as readable text
                const itemsText = order.items.map(item => 
                    `${item.title} | Tamanho: ${item.size} | Quantidade: ${item.qty} | Preço: ${item.price}`
                ).join('\n');
                
                // Format as form-data for Formspree compatibility
                const formData = new FormData();
                formData.append('Data', formattedDate);
                formData.append('Nome', order.name);
                formData.append('Telemóvel', order.phone);
                formData.append('Relação com a AUR', order.relation);
                formData.append('Escalão', order.scale);
                formData.append('Método de pagamento', order.payment);
                formData.append('Itens', itemsText);
                formData.append('Total', order.total.toString());
                formData.append('Notas', order.notes);
                
                // Fire the request but don't wait for response (CORS issues)
                // Formspree will process it server-side regardless
                fetch(ORDER_ENDPOINT, {
                    method: 'POST',
                    body: formData
                }).catch(e => console.log('Fetch sent (CORS may block response):', e));
                
                // Always return success since Formspree queues it server-side
                return { ok: true };
            } catch (e) {
                console.error('Order submit error', e);
                return { ok: false, error: e };
            }
        }

        // Checkout via email composition
        document.addEventListener('DOMContentLoaded', () => {
            const checkoutBtn = document.getElementById('checkoutButton');
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', () => {
                    if (cart.length === 0) {
                        alert('O carrinho está vazio.');
                        return;
                    }
                    const relation = document.getElementById('relation').value;
                    const scale = document.getElementById('scale').value;
                    const payment = document.getElementById('payment').value;
                    const name = document.getElementById('buyerName').value.trim();
                    const phone = document.getElementById('buyerPhone').value.trim();
                    const notes = document.getElementById('notes').value.trim();
                    if (!relation || !scale || !payment || !name) {
                        alert('Por favor preencha Relação, Escalão, Método de pagamento, e Nome.');
                        return;
                    }
                    const lines = cart.map(ci => {
                        const item = shopItems.find(i => i.id === ci.id);
                        const priceStr = item ? priceStringForItem(item) : '0';
                        return `• ${ci.title} | Tam: ${ci.size} | Qt: ${ci.qty} | Preço: ${priceStr}`;
                    });
                    const total = cart.reduce((sum, ci) => {
                        const item = shopItems.find(i => i.id === ci.id);
                        const priceStr = item ? priceStringForItem(item) : '0';
                        return sum + priceNumber(priceStr) * ci.qty;
                    }, 0);
                    const intro = `Este formulário será utilizado para efetuar encomendas da Academia Ubuntu Rugby.\n` +
                                   `Todas as encomendas efetuadas só serão válidas após efetuado o pagamento.\n` +
                                   `O pagamento pode ser efetuado em dinheiro ou por Mbway, para o nº de telemóvel da AUR:\n` +
                                   `932 606 500.`;

                    const emailBodyText =
                        `${intro}\n\n` +
                        `Pedido Loja Ubuntu\n\n` +
                        `Relação com a AUR: ${relation}\n` +
                        `Escalão: ${scale}\n` +
                        `Método de pagamento: ${payment}\n\n` +
                        `Nome: ${name}\n\nTelefone: ${phone}\n\n` +
                        `Itens:\n${lines.join('\n')}\n\n` +
                        `Total: ${total} bolas\n\n` +
                        `Notas: ${notes}`;

                    // Build order object for optional backend submit (email + sheet)
                    const order = {
                        timestamp: new Date().toISOString(),
                        name,
                        relation,
                        scale,
                        payment,
                        phone,
                        notes,
                        total,
                        items: cart.map(ci => {
                            const item = shopItems.find(i => i.id === ci.id);
                            const priceStr = item ? priceStringForItem(item) : '0';
                            return { title: ci.title, size: ci.size, qty: ci.qty, price: priceStr };
                        })
                    };

                    // Fire-and-forget submit to Formspree (if configured)
                    submitOrderToSheet(order).then(r => {
                        if (r?.ok) {
                            alert('Pedido enviado com sucesso.');
                            // Clear cart after successful submission
                            cart.length = 0;
                            saveCart();
                            renderCart();
                            // Close cart offcanvas
                            const offcanvasEl = document.getElementById('cartOffcanvas');
                            const oc = bootstrap.Offcanvas.getInstance(offcanvasEl);
                            if (oc) oc.hide();
                        } else if (r?.skipped) {
                            // Fallback: abrir email se endpoint não estiver configurado
                            const subject = encodeURIComponent('Pedido de Loja Ubuntu Rugby');
                            const body = encodeURIComponent(emailBodyText);
                            window.location.href = `mailto:geral@ubunturugby.pt?subject=${subject}&body=${body}`;
                        } else {
                            alert('Não foi possível enviar automaticamente. Por favor tente novamente.');
                        }
                    });
                });
            }
            const relationSelect = document.getElementById('relation');
            if (relationSelect) {
                relationSelect.addEventListener('change', () => {
                    priceMode = relationSelect.value === 'Outro' ? 'others' : 'members';
                    renderCart();
                });
            }
            updateCartBadge();
            renderCart();
        });

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
        crossorigin="anonymous"></script>

    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
        AOS.init();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAoa3jKyoHLP2uXtkIYZSmk3UbwTkKDifU",
            authDomain: "ubuntu-rugby.firebaseapp.com",
            projectId: "ubuntu-rugby",
            storageBucket: "ubuntu-rugby.appspot.com",
            messagingSenderId: "840013360731",
            appId: "1:840013360731:web:ab6171d67e814b0e6d197e",
            measurementId: "G-Q42T9Z76XB"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
    </script>
</body>

</html>